name: Release on Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        shell: pwsh
        run: python build.py

      - name: Locate artifacts
        id: locate
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path dist -Filter *.exe | Select-Object -First 1 -ExpandProperty FullName
          if (-not $exe) { throw "No .exe found in dist" }
          $zip = Get-ChildItem -Path dist -Filter *.zip | Select-Object -First 1 -ExpandProperty FullName
          if (-not $zip) { throw "No .zip found in dist" }
          echo "artifact=$exe" | Out-File -Append $Env:GITHUB_OUTPUT
          echo "basename=$(Split-Path $exe -Leaf)" | Out-File -Append $Env:GITHUB_OUTPUT
          echo "zipartifact=$zip" | Out-File -Append $Env:GITHUB_OUTPUT
          echo "zipbasename=$(Split-Path $zip -Leaf)" | Out-File -Append $Env:GITHUB_OUTPUT

      - name: Compute SHA-256
        id: hash
        shell: pwsh
        run: |
          $exe = "${{ steps.locate.outputs.artifact }}"
          $basename = "${{ steps.locate.outputs.basename }}"
          $hash = (Get-FileHash $exe -Algorithm SHA256).Hash
          $out = Join-Path (Split-Path $exe -Parent) "$basename.sha256.txt"
          "$hash  $basename" | Set-Content $out
          "hashfile=$out" | Out-File -Append $Env:GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: notes
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $lines = Get-Content CHANGELOG.md
          $startIndex = -1
          for ($i=0; $i -lt $lines.Count; $i++) {
            if ($lines[$i] -match "^## \[${version}\]") { $startIndex = $i; break }
          }
          $endIndex = $lines.Count
          if ($startIndex -ge 0) {
            for ($j=$startIndex+1; $j -lt $lines.Count; $j++) {
              if ($lines[$j] -match "^## \[") { $endIndex = $j; break }
            }
            $slice = $lines[$startIndex..($endIndex-1)]
          } else {
            $slice = @("Release $version")
          }
          $header = @(
            "## ðŸ“¥ Download (Windows)",
            "",
            "- Baixe o arquivo do app em **Assets**: `DahoraApp_latest.zip` (recomendado) ou `DahoraApp_v$version.zip`.",
            ""
          )
          $out = "dist/release_notes_$version.md"
          $header + $slice | Set-Content $out
          echo "notes_path=$out" | Out-File -Append $Env:GITHUB_OUTPUT

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: ${{ steps.notes.outputs.notes_path }}
          files: |
            ${{ steps.locate.outputs.artifact }}
            ${{ steps.locate.outputs.zipartifact }}
            ${{ steps.hash.outputs.hashfile }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload stable assets (latest)
        shell: pwsh
        run: |
          $exeTmp = Join-Path $env:RUNNER_TEMP "DahoraApp_latest.exe"
          $zipTmp = Join-Path $env:RUNNER_TEMP "DahoraApp_latest.zip"
          Copy-Item -Force "${{ steps.locate.outputs.artifact }}" $exeTmp
          Copy-Item -Force "${{ steps.locate.outputs.zipartifact }}" $zipTmp

          gh release upload "${{ github.ref_name }}" $exeTmp $zipTmp --clobber --repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
